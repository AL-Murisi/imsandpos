generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Company {
  id                                                 String               @id @default(cuid())
  name                                               String
  email                                              String?              @unique(map: "unique_company_email")
  phone                                              String?
  address                                            String?
  city                                               String?
  state                                              String?
  base_currency  String @default("YER") @db.VarChar(3) // Main currency
  maxBranches   Int @default(1)
  maxCashiers   Int @default(1)
  plan          String @default("STARTER") // STARTER, PRO, ENTERPRISE

  country                                            String?
  taxNumber                                          String?              @map("tax_number")
  logoUrl                                            String?              @map("logo_url")
  footerMsg                                          String?              @map("footer_msg")
  isActive                                           Boolean              @default(true) @map("is_active")
  createdAt                                          DateTime             @default(now()) @map("created_at")
  updatedAt                                          DateTime             @updatedAt @map("updated_at")
  activityLogs                                       ActivityLogs[]
  accounts                                           accounts[]
  brands                                             Brand[]
  categories                                         Category[]
  customers                                          Customer[]
  pushSubscription                                     pushSubscription[]
  expenses                                           expenses[]
  inventory                                          Inventory[]
  journal_entries                                    journal_entries[]

  branches                                            points_of_sale[]    
  products                                           Product[]

  stockMovements                                     StockMovement[]
 
  suppliers                                          Supplier[]
  users                                              User[]
  warehouses                                         Warehouse[]
  journal_events                                    journalEvent[]
  account_mappings                                  account_mappings[]
  fiscal_periods                                   fiscal_periods[]
  Employee                                        Employee[]
  Bank                                            Bank[]
  FinancialTransaction                       FinancialTransaction []   
  Invoice                                         Invoice[]
  InvoiceItem                                     InvoiceItem[]
  exchange_rates exchange_rates[]

  @@map("companies")
}

model User {
  id                                                 String            @id @default(cuid())
  companyId                                          String            @map("company_id")
  email                                              String            @unique
  name                                               String
  phoneNumber                                        String?           @map("phone_number")
  password                                           String?
  supabaseId                                         String?           @unique @map("supabase_id")
  isActive                                           Boolean           @default(true) @map("is_active")
  createdAt                                          DateTime          @default(now()) @map("created_at")
  updatedAt                                          DateTime          @updatedAt @map("updated_at")
  
  branchId  String? @map("branch_id")

  branch    points_of_sale? @relation(fields: [branchId], references: [id])
  activityLogs                                       ActivityLogs[]
  expenses                                           expenses[]
  journal_entries_journal_entries_created_byTousers  journal_entries[] @relation("journal_entries_created_byTousers")
  journal_entries_journal_entries_updated_byTousers  journal_entries[] @relation("journal_entries_updated_byTousers")
  managedBranches                                     points_of_sale[]  @relation("BranchManager")
  transaction                                           FinancialTransaction[]
  stockMovements                                     StockMovement[]
  roles                                              UserRole[]
  company                                            Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  invoices Invoice[] @relation("UserSales")
  employees Employee[] // üëà ADD THIS
  @@index([companyId])
  @@index([name])
  @@index([phoneNumber])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}
model exchange_rates {
  id            String   @id @default(cuid())
  company_id    String
  from_currency String   @db.VarChar(3) // "USD"
  to_currency   String   @db.VarChar(3) // "YER"
  rate          Decimal  @db.Decimal(18, 6)
  date          DateTime @default(now())
  
  company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)
  
  @@unique([company_id, from_currency, to_currency, date])
  @@index([company_id])
  @@index([date])
  @@map("exchange_rates")
}

model ActivityLogs {
  id        String   @id @default(cuid())
  companyId String   @map("company_id")
  userId    String   @map("user_id")
  action    String
  details   String?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now()) @map("created_at")
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId])
  @@index([createdAt])
}

model Role {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  permissions Json
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  users       UserRole[]

  @@map("roles")
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([roleId])
  @@map("user_roles")
}

model Warehouse {
  id             String          @id @default(cuid())
  companyId      String          @map("company_id")
  name           String
  location       String
  branchId       String?
  address        String?
  city           String?
  state          String?
  country        String?
  postalCode     String?         @map("postal_code")
  phoneNumber    String?         @map("phone_number")
  email          String?
  isActive       Boolean         @default(true) @map("is_active")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  inventory      Inventory[]
  products       Product[]
  stockMovements StockMovement[]
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
 invoices Invoice[]

  branch    points_of_sale? @relation(fields: [branchId], references: [id])
  @@index([companyId])
  @@index([isActive])
  @@index([createdAt])
  @@map("warehouses")
}

model Category {
  id          String     @id @default(cuid())
  companyId   String     @map("company_id")
  name        String
  description String?
  parentId    String?    @map("parent_id")
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("categories")
}

model Brand {
  id          String    @id @default(cuid())
  companyId   String    @map("company_id")
  name        String
  description String?
  website     String?
  contactInfo String?   @map("contact_info")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products    Product[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("brands")
}

model Supplier {
  id                 String            @id @default(cuid())
  companyId          String            @map("company_id")
  name               String
  contactPerson      String?           @map("contact_person")
  email              String?
  phoneNumber        String?           @map("phone_number")
  address            String?
  city               String?
  state              String?
  preferred_currency Json?     @map("allowed_currencies")

 
  country            String?
  postalCode         String?           @map("postal_code")
  taxId              String?           @map("tax_id")
  paymentTerms       String?           @map("payment_terms")
  isActive           Boolean           @default(true) @map("is_active")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")
  totalPurchased     Decimal           @default(0) @map("total_purchased") @db.Decimal(12, 2)
  totalPaid          Decimal           @default(0) @map("total_paid") @db.Decimal(12, 2)
  outstandingBalance Decimal           @default(0) @map("outstanding_balance") @db.Decimal(12, 2)
  products           Product[]
 

  company            Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transaction           FinancialTransaction[]
  invoice                Invoice[]

  @@index([companyId])
  @@map("suppliers")
}

model Product {
  id               String          @id @default(cuid())
  companyId        String          @map("company_id")
  name             String
  sku              String
  barcode          String?
  description      String?
  branch_id        String?
  categoryId       String          @map("category_id")
  brandId          String?         @map("brand_id")
  supplierId       String?         @map("supplier_id")
  warehouseId      String          @map("warehouse_id")
  type             String?
  sellingUnits     Json? 
  unitsPerPacket   Int             @map("units_per_packet")
  packetsPerCarton Int             @map("packets_per_carton")
  costPrice        Decimal         @map("cost_price") @db.Decimal(10, 2)
  pricePerUnit     Decimal?        @map("price_per_unit") @db.Decimal(10, 2)
  pricePerPacket   Decimal         @map("price_per_packet") @db.Decimal(10, 2)
  pricePerCarton   Decimal         @map("price_per_carton") @db.Decimal(10, 2)
  wholesalePrice   Decimal         @map("wholesale_price") @db.Decimal(10, 2)
  minWholesaleQty  Int             @map("min_wholesale_qty")
  weight           Decimal?        @db.Decimal(8, 3)
  dimensions       String?
  image            String?
  status           String          @default("active")
  isActive         Boolean         @default(true) @map("is_active")
  expiredAt        DateTime        @default(now()) @map("  expired_at")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  inventory        Inventory[]
  brand            Brand?          @relation(fields: [brandId], references: [id])
  category         Category        @relation(fields: [categoryId], references: [id])
  company          Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier         Supplier?       @relation(fields: [supplierId], references: [id])
  warehouse        Warehouse       @relation(fields: [warehouseId], references: [id])
  points_of_sale points_of_sale? @relation(fields: [branch_id], references: [id])


  stockMovements   StockMovement[]
  invoiceItems InvoiceItem[]
  @@unique([companyId, sku])
  @@unique([companyId, barcode])
  @@index([companyId])
  @@index([categoryId])
  @@index([brandId])
  @@index([supplierId])
  @@index([warehouseId])
  @@index([status])
  @@index([createdAt], map: "idx_product_created_at")
  @@map("products")
}

model Inventory {
  id                String    @id @default(cuid())
  companyId         String    @map("company_id")
  productId         String    @map("product_id")
  warehouseId       String    @map("warehouse_id")
  stockQuantity     Int       @map("stock_quantity")
  reservedQuantity  Int       @default(0) @map("reserved_quantity")
  availableQuantity Int       @map("available_quantity")
  reorderLevel      Int       @default(0) @map("reorder_level")
  maxStockLevel     Int?      @map("max_stock_level")
  location          String?
  branchId            String?
  purchaseReceipt    String?  
  lastPurchaseId     String?
  lastPurchaseItemId String?
  receiptNo     String?   @unique
  status            String    @default("available")
  lastStockTake     DateTime? @map("last_stock_take")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // RELATIONS
   branch  points_of_sale? @relation(fields: [branchId], references: [id])

  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  // NEW RELATIONS

  @@unique([companyId, productId, warehouseId])
  @@map("inventory")
}


model StockMovement {
  id             String    @id @default(cuid())
  companyId      String    @map("company_id")
  productId      String    @map("product_id")
  warehouseId    String    @map("warehouse_id")
  userId         String    @map("user_id")
  movementType   String
  quantity       Int
  reason         String?
  quantityBefore Int       @map("quantity_before")
  quantityAfter  Int       @map("quantity_after")
  referenceType  String?   @map("reference_type")
  referenceId    String?   @map("reference_id")
  notes          String?
  createdAt      DateTime  @default(now()) @map("created_at")
  company        Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product        Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id])
  warehouse      Warehouse @relation(fields: [warehouseId], references: [id])

  @@index([companyId])
  @@index([productId])
  @@index([userId])
  @@index([warehouseId])
  @@index([movementType])
  @@index([reason])
  @@index([createdAt])
  @@map("stock_movements")
}

model Customer {
  id                 String    @id @default(cuid())
  companyId          String    @map("company_id")
  name               String
  email              String?
  phoneNumber        String?   @map("phone_number")
  address            String?
  city               String?
  state              String?
  country            String?
  preferred_currency Json?     @map("allowed_currencies")
  branch_id  String?
  customerType       String    @default("individual") @map("customer_type")
  taxId              String?   @map("tax_id")
  creditLimit        Decimal?  @map("credit_limit") @db.Decimal(10, 2)
  outstandingBalance Decimal   @default(0) @map("outstanding_balance") @db.Decimal(10, 2)
  isActive           Boolean   @default(true) @map("is_active")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  balance            Decimal?  @default(0) @map("balance") @db.Decimal(10, 2)
  company            Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

 transaction           FinancialTransaction[]
 invoice                Invoice[]

  points_of_sale points_of_sale? @relation(fields: [branch_id], references: [id])

  @@unique([companyId, email])
  @@index([companyId])
  @@index([name])
  @@index([phoneNumber])
  @@index([isActive])
  @@index([createdAt])

  @@map("customers")
}


model journalEvent {
  id          String     @id @default(uuid())
  companyId   String     @map("company_id")
  entityId    String?    @map("entity_id")   // saleId, paymentId, returnId, etc.
  entityType  String     @map("entity_type") // "sale" | "return" | "payment" | "refund" | "inventory"
  eventType   String     @map("event_type")  // "completed" | "updated" | "deleted" ...
  payload     Json       @map("payload")     // Full data snapshot
  processed   Boolean    @map("processed") @default(false)
  createdAt   DateTime   @map("created_at") @default(now())
  status      String   // "PENDING", "COMPLETED", "FAILED"
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([entityId])
  @@index([entityType])
  @@index([companyId])
  @@map("journal_events")
}


model FinancialTransaction {
  id              String   @id @default(cuid())
  companyId       String   @map("company_id")
  
  // ŸÜŸàÿπ ÿßŸÑÿ≥ŸÜÿØ: ŸÇÿ®ÿ∂ (RECEIPT) ÿ£Ÿà ÿµÿ±ŸÅ (PAYMENT)
  type         TransactionType @default(PAYMENT)
  
  // ÿßŸÑÿ£ÿ∑ÿ±ÿßŸÅ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© (ŸÉŸÑŸáÿß ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿ© ŸÑŸäŸÉŸàŸÜ ÿßŸÑÿ¨ÿØŸàŸÑ ŸÖÿ±ŸÜÿßŸã)
  customerId      String?  @map("customer_id")
  supplierId      String?  @map("supplier_id")
  userId          String?  @map("user_id") // ŸÑŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ£Ÿà ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑÿ•ÿØÿßÿ±Ÿäÿ©
    expenseId       String?  @map("expense_id") @db.Uuid

  branchId        String?
  // ÿßŸÑÿ±ÿ®ÿ∑ ÿ®ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
  saleId          String?  @map("sale_id")
  purchaseId      String?  @map("purchase_id")
  voucherNumber Int            @map("voucher_number")
  // ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿßŸÑŸäÿ©
  amount          Decimal  @db.Decimal(12, 2)
  currencyCode    String   @map("currency_code") @db.VarChar(3)
  exchangeRate    Decimal? @map("exchange_rate") @db.Decimal(18, 6)
  
  paymentMethod   String   @map("payment_method") // ŸÉÿßÿ¥ÿå ÿ®ŸÜŸÉÿå ÿ¥ŸäŸÉ
  referenceNumber String?  @map("reference_number") // ÿ±ŸÇŸÖ ÿßŸÑÿ¥ŸäŸÉ ÿ£Ÿà ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ
  invoiceId       String?  // Ensure the foreign key exists

  status          String   @default("completed")
  notes           String?
  date            DateTime @default(now()) @map("transaction_date")
  createdAt       DateTime @default(now()) @map("created_at")
  
  // ÿßŸÑÿπŸÑÿßŸÇÿßÿ™
  expense         expenses? @relation(fields: [expenseId], references: [id])
  
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer? @relation(fields: [customerId], references: [id])
  supplier        Supplier? @relation(fields: [supplierId], references: [id])
  user        User? @relation(fields: [userId], references: [id])
  points_of_sale points_of_sale? @relation(fields: [branchId], references: [id])
  invoice   Invoice? @relation(fields: [invoiceId], references: [id]) // <--- Add this line

  @@unique([companyId, type, voucherNumber])
  @@index([companyId, type])
  @@map("financial_transactions")
}


model OfflineOperation {
  id        String    @id @default(cuid())
  companyId String    @map("company_id")
  userId    String    @map("user_id")
  operation String
  tableName String    @map("table_name")
  recordId  String    @map("record_id")
  data      Json
  status    String    @default("pending")
  createdAt DateTime  @default(now()) @map("created_at")
  syncedAt  DateTime? @map("synced_at")

  @@index([companyId])
  @@map("offline_operations")
}


/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model expenses {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id         String
  user_id            String
  account_id         String?             @db.Uuid
  expense_number     String              @unique @db.VarChar(255)
  description        String?
  branchId           String?
  amount             Decimal             @db.Decimal(12, 2)
  expense_date       DateTime            @db.Date
  payment_method     String?             @db.VarChar(50)
  reference_number   String?             @db.VarChar(255)
  receipt_url        String?
  notes              String?
  status             String?             @default("pending") @db.VarChar(50)
  is_active          Boolean?            @default(true)
  created_at         DateTime?           @default(now()) @db.Timestamp(6)
  updated_at         DateTime?           @default(now()) @db.Timestamp(6)
  branch                          points_of_sale? @relation(fields: [branchId], references: [id])                 

  companies          Company             @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_expense_company")
  users              User                @relation(fields: [user_id], references: [id], onDelete: SetNull, onUpdate: NoAction, map: "fk_expense_user")
 transactions         FinancialTransaction[]
  
  @@index([company_id], map: "idx_expense_company")
  @@index([company_id, expense_date], map: "idx_expense_company_date")
  @@index([created_at], map: "idx_expense_created_at")
  @@index([expense_date], map: "idx_expense_date")
  @@index([status], map: "idx_expense_status")
    @@index([status, expense_date], map: "idx_expense_status_date")
   @@index([user_id], map: "idx_expense_user")
}

model accounts {
  id               String            @id @default(dbgenerated("gen_random_uuid()"))
  company_id       String
  account_code     String
  account_name_en  String
  account_name_ar  String?
  account_type     account_type
  account_category account_category
  parent_id        String?
  level            Int?              @default(1)
  is_active        Boolean?          @default(true)
  is_system        Boolean?          @default(false)  // NEW: System accounts can't be deleted
  allow_manual_entry Boolean?        @default(true)   // NEW: Some accounts only accept automatic entries
  balance          Decimal?          @default(0) @db.Decimal(15, 2)
  opening_balance  Decimal?          @default(0) @db.Decimal(15, 2)  // NEW
  currency_code   String?    
  description      String?                                             // NEW
  created_at       DateTime?         @default(now()) @db.Timestamptz(6)
  updated_at       DateTime?         @default(now()) @db.Timestamptz(6)
  
  companies        Company           @relation(fields: [company_id], references: [id], onDelete: Cascade)
  accounts         accounts?         @relation("accountsToaccounts", fields: [parent_id], references: [id])
  other_accounts   accounts[]        @relation("accountsToaccounts")
  journal_entries  journal_entries[]
  account_mappings account_mappings[]  // NEW: Link to business transactions
    banks     Bank[]  // üëà ADD THIS 
 

  employeePayables  Employee[] @relation("EmployeePayableAccount")
  @@unique([company_id, account_code])
  @@index([company_id])
  @@index([parent_id])
  @@index([account_type])
  @@index([is_active])
}
model Bank {
  id            String   @id @default(cuid())
  companyId     String   @map("company_id")
  name          String
  branch        String?
  iban          String?
  swiftCode     String?  @map("swift_code")
  accountNumber String? @map("account_number")
  isActive      Boolean @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
   preferred_currency Json?     @map("allowed_currencies")

  // üîë Accounting link
  accountId     String  @map("account_id")
  account       accounts @relation(fields: [accountId], references: [id], onDelete: Cascade)

  company       Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@index([companyId])
  @@map("banks")
}
model Employee {
  id             String   @id @default(cuid())
  companyId      String   @map("company_id")
  userId         String?  @map("user_id") // optional login
  employeeCode   String   @unique
  name           String
  phone          String?
  email          String?
  position       String?
  department     String?
  salary         Decimal? @db.Decimal(12,2)
  hireDate       DateTime @map("hire_date")
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // üîë Payroll account (optional)
   payableAccountId String?   @map("payable_account_id")
  payableAccount   accounts? @relation("EmployeePayableAccount", fields: [payableAccountId], references: [id])
  company        Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user           User?   @relation(fields: [userId], references: [id])

  @@index([companyId])
  @@index([department])
  @@index([isActive])
  @@map("employees")
}

model account_mappings {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  company_id  String
  mapping_type String  // 'sales_revenue', 'sales_tax', 'inventory', 'cogs', 'cash', 'accounts_receivable', etc.
  account_id  String
  is_default  Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @db.Timestamptz(6)
  
  companies   Company  @relation(fields: [company_id], references: [id], onDelete: Cascade)
  accounts    accounts @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@unique([company_id, mapping_type])
  @@index([company_id])
  @@index([mapping_type])
}

model journal_entries {
  id                                      String    @id @default(dbgenerated("gen_random_uuid()"))
  company_id                              String
  entry_number                            String    // NEW: JE-2024-001
  account_id                              String
  description                             String?
  branch_id                               String?
  entry_date                              DateTime? @default(now()) @db.Timestamptz(6)
  debit                                   Decimal  @default(0) @db.Decimal(15, 2)
  credit                                  Decimal  @default(0) @db.Decimal(15, 2)
  is_posted                               Boolean?  @default(false)
  is_automated                            Boolean?  @default(false)  // NEW: Auto-generated or manual
  reference_type                          String?   // NEW: 'sale', 'purchase', 'expense', 'payment'
  reference_id                            String?   // NEW: ID of the related transaction
  fiscal_period                           String?   // NEW: '2024-01', '2024-Q1'
  created_by                              String 
  currency_code                            String?            @db.VarChar(3)   
   foreign_amount    Decimal? @db.Decimal(15, 2) @map("foreign_amount")
  exchange_rate     Decimal? @db.Decimal(18, 6) @map("exchange_rate")
  base_amount       Decimal? @db.Decimal(15, 2) @map("base_amount") 
  updated_by                              String?
  posted_by                               String?   // NEW
  posted_at                               DateTime? @db.Timestamptz(6)  // NEW
  created_at                              DateTime? @default(now()) @db.Timestamptz(6)
  updated_at                              DateTime? @default(now()) @db.Timestamptz(6)
         
  points_of_sale                          points_of_sale? @relation(fields: [branch_id], references: [id])                 
  accounts                                accounts  @relation(fields: [account_id], references: [id], onDelete: Cascade)
  companies                               Company   @relation(fields: [company_id], references: [id], onDelete: Cascade)
  users_journal_entries_created_byTousers User      @relation("journal_entries_created_byTousers", fields: [created_by], references: [id])
  users_journal_entries_updated_byTousers User?     @relation("journal_entries_updated_byTousers", fields: [updated_by], references: [id])

  @@unique([company_id, branch_id, entry_number])
  @@unique([reference_id, entry_number])
  @@index([account_id])
  @@index([company_id])
  @@index([created_by])
  @@index([entry_date])
  @@index([reference_type, reference_id])  // NEW: Quick lookup for transaction journals
  @@index([is_posted])
  @@index([fiscal_period])
}
model pushSubscription {
  id        String   @id @default(uuid())
  endpoint  String   @unique
  p256dh    String
  auth      String
  company_id  String
  userId    String?
  role      String?  // "ADMIN", "CASHIER"
  companies                               Company   @relation(fields: [company_id], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// NEW: Fiscal periods for closing books
model fiscal_periods {
  id          String    @id @default(dbgenerated("gen_random_uuid()"))
  company_id  String
  period_name String    // '2024-01', '2024-Q1', '2024'
  start_date  DateTime  @db.Date
  end_date    DateTime  @db.Date
  is_closed   Boolean   @default(false)
  closed_by   String?
  closed_at   DateTime? @db.Timestamptz(6)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  
  companies   Company   @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@unique([company_id, period_name])
  @@index([company_id])
  @@index([start_date, end_date])
}


model points_of_sale {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  company_id String
  name       String
  location   String?
  managerId  String?
  is_active  Boolean? @default(true)
  created_at DateTime? @default(now())
  updated_at DateTime? @default(now())
  cashiers  User[]
  company Company @relation(fields: [company_id], references: [id])
  manager User? @relation("BranchManager", fields: [managerId], references: [id])
   // üëà all users with branchId = this.id

  expense           expenses[]
  products       Product[]
  customers      Customer[]
  transactions   FinancialTransaction[]
  journalEntries journal_entries[]
  invoices       Invoice[]
  warehouses  Warehouse[]
  inventory    Inventory[]
  @@map("points_of_sale")
}

enum account_category {
  // Assets
    CASH_AND_BANK
  CASH
  BANK
  ACCOUNTS_RECEIVABLE
  INVENTORY
  OTHER_CURRENT_ASSETS
  FIXED_ASSETS
  ACCUMULATED_DEPRECIATION
  OTHER_ASSETS
  
  // Liabilities
  ACCOUNTS_PAYABLE
  CREDIT_CARD
  SHORT_TERM_LOANS
  SALES_TAX_PAYABLE
  ACCRUED_EXPENSES
  OTHER_CURRENT_LIABILITIES
  LONG_TERM_LIABILITIES
  
  // Equity
  OWNER_EQUITY
  RETAINED_EARNINGS
  DRAWINGS
  
  // Revenue
  SALES_REVENUE
  SERVICE_REVENUE
  OTHER_INCOME
  
  // Expenses
  COST_OF_GOODS_SOLD
  OPERATING_EXPENSES
  PAYROLL_EXPENSES
  ADMINISTRATIVE_EXPENSES
  OTHER_EXPENSES
  HOUSE_EXPENSES
}

enum account_type {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
  COST_OF_GOODS
}
enum TransactionType {
  RECEIPT // ŸÇÿ®ÿ∂ (ŸÖŸÜ ÿπŸÖŸäŸÑ)
  PAYMENT // ÿµÿ±ŸÅ (ŸÑŸÖŸàÿ±ÿØ ÿ£Ÿà ŸÖÿµÿ±ŸàŸÅ)

}

model InvoiceItem {
  id              String   @id @default(cuid())
  invoiceId       String   @map("invoice_id")
  productId       String   @map("product_id")
  companyId       String
  quantity        Decimal  @db.Decimal(12, 3)
  // ÿßŸÑÿ≥ÿπÿ± (Ÿäÿ≥ŸÖŸâ UnitCost ŸÅŸä ÿßŸÑÿ¥ÿ±ÿßÿ° Ÿà UnitPrice ŸÅŸä ÿßŸÑÿ®Ÿäÿπ)
  price           Decimal  @db.Decimal(12, 2)
  totalPrice      Decimal  @db.Decimal(12, 2)
  unit     String  

  // ŸÅŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ŸÜÿ≠ÿ™ÿßÿ¨ ŸÑÿÆÿµŸÖÿå ŸÅŸä ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ ŸÇÿØ ŸÑÿß ŸÜÿ≠ÿ™ÿßÿ¨Ÿá ÿØÿßÿ¶ŸÖÿßŸã
  discountAmount  Decimal? @default(0) @db.Decimal(12, 2)

  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id])
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}
model Invoice {
  id              String   @id @default(cuid())
  companyId       String   @map("company_id")
  invoiceNumber   String   @map("invoice_number")
  cashierId        String          @map("cashier_id")
  branchId        String?
  warehouseId     String?
  // ÿßŸÑÿ™ŸÖŸäŸäÿ≤ ÿ®ŸäŸÜ ÿßŸÑÿ®Ÿäÿπ ŸàÿßŸÑÿ¥ÿ±ÿßÿ°
  sale_type            InvoiceType @default(SALE) // SALE, PURCHASE, RETURN_SALE, RETURN_PURCHASE
  // ÿßŸÑÿ£ÿ∑ÿ±ÿßŸÅ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©)
  customerId      String?  @map("customer_id")
  supplierId      String?  @map("supplier_id")

  totalAmount     Decimal  @db.Decimal(12, 2)
  amountPaid      Decimal  @default(0) @db.Decimal(12, 2)
  amountDue       Decimal  @default(0) @db.Decimal(12, 2)

  status          String   @default("completed") // pending, completed, cancelled
  invoiceDate     DateTime @default(now()) @map("invoice_date")
  cashier      User?     @relation("UserSales", fields: [cashierId], references: [id])

  branch    points_of_sale? @relation(fields: [branchId], references: [id])
  warehouse Warehouse?     @relation(fields: [warehouseId], references: [id])
  customer         Customer?       @relation(fields: [customerId], references: [id])
  supplier      Supplier?       @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  // ÿßŸÑÿπŸÑÿßŸÇÿßÿ™
  items           InvoiceItem[]
  transactions    FinancialTransaction[]
 
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  @@unique([companyId, invoiceNumber, sale_type])
  @@map("invoices")
}

enum InvoiceType {
  SALE
  PURCHASE
  RETURN_SALE
  RETURN_PURCHASE
}
